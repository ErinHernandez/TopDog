# Dynamic Island Alerts - Complete Integration Guide

**Status:** Implementation Complete - Ready for Integration  
**Last Updated:** January 2026

---

## üéØ Quick Start

The Dynamic Island Alert System is **95% complete**. Follow these steps to finish integration:

1. ‚úÖ **Code Complete** - All TypeScript, Swift, and configuration files are ready
2. ‚è≥ **Add Sound Files** - Create or source 2 MP3 files
3. ‚è≥ **Test Service Worker** - Verify notification clicks work
4. ‚è≥ **Integrate iOS Handler** - Add WebView message handler
5. ‚è≥ **Test on Devices** - Verify all 5 alert types

---

## üìã Integration Checklist

### Phase 1: Sound Files ‚úÖ (5 minutes)

**Location:** `public/sounds/`

**Required Files:**
- `your-turn.mp3` - For "On The Clock" alert (0.5-2 seconds, 800Hz tone recommended)
- `urgent-beep.mp3` - For "10 Seconds Remaining" alert (0.2-1 second, 1200Hz tone recommended)

**Quick Option - Generate Placeholder Sounds:**
```bash
# If you have ffmpeg installed
./scripts/create-placeholder-sounds.sh

# Or manually create simple beep tones
# Or download royalty-free alert sounds from freesound.org
```

**Specifications:**
- Format: MP3
- Duration: 0.5-2 seconds (short, non-intrusive)
- Volume: Normalized to -12dB to -6dB
- Sample Rate: 44.1kHz or 48kHz
- Bitrate: 128kbps minimum

---

### Phase 2: Service Worker Integration ‚úÖ (Automatic)

**Status:** ‚úÖ **AUTOMATED** - Post-build script added

The service worker notification click handler is now **automatically merged** after each build.

**What Changed:**
- ‚úÖ `scripts/merge-service-worker.js` - Post-build merge script
- ‚úÖ `package.json` - Build script updated to run merge automatically
- ‚úÖ `public/sw-custom.js` - Custom handler code

**How It Works:**
1. `next build` generates `public/sw.js` (auto-generated by next-pwa)
2. Post-build script automatically appends notification click handler
3. No manual steps required!

**Verify It Works:**
```bash
# Build the project
npm run build

# Check that sw.js contains notificationclick handler
grep -q "notificationclick" public/sw.js && echo "‚úÖ Handler merged" || echo "‚ùå Handler missing"
```

**Manual Override (if needed):**
If the automatic merge fails, manually append `public/sw-custom.js` content to `public/sw.js` after each build.

---

### Phase 3: iOS WebView Integration ‚è≥ (15 minutes)

**Status:** Code provided, needs integration into iOS app

**File:** `ios/DynamicIsland/README_ALERTS.md` (complete guide)

**Quick Steps:**

1. **Add Files to Xcode:**
   - `ios/DynamicIsland/Managers/DraftAlertManager.swift` ‚Üí Main app target
   - `ios/DynamicIsland/Widgets/DraftAlertWidget.swift` ‚Üí Widget Extension target

2. **Enable Live Activities:**
   - Widget Extension target ‚Üí Signing & Capabilities
   - Add "Live Activities" capability

3. **Add WebView Message Handler:**

Find your WebView configuration (likely `WebViewController.swift` or similar) and add:

```swift
// In your WKWebView configuration
let contentController = WKUserContentController()
contentController.add(self, name: "draftAlert") // ADD THIS LINE

// Add protocol conformance
extension YourWebViewController: WKScriptMessageHandler {
    func userContentController(
        _ userContentController: WKUserContentController,
        didReceive message: WKScriptMessage
    ) {
        guard message.name == "draftAlert",
              let body = message.body as? [String: Any],
              let action = body["action"] as? String,
              action == "showAlert",
              let alertData = body["alert"] as? [String: Any] else {
            return
        }
        
        // Parse alert data
        guard let typeString = alertData["type"] as? String,
              let type = DraftAlertManager.AlertType(rawValue: typeString),
              let message = alertData["message"] as? String,
              let roomId = alertData["roomId"] as? String,
              let timestamp = alertData["timestamp"] as? TimeInterval else {
            return
        }
        
        // Show the alert
        Task { @MainActor in
            let data = DraftAlertManager.AlertData(
                type: type,
                message: message,
                roomId: roomId,
                timestamp: timestamp
            )
            try? await DraftAlertManager.shared.showAlert(data)
        }
    }
}
```

**See:** `ios/DynamicIsland/README_ALERTS.md` for complete instructions

---

### Phase 4: Testing ‚è≥ (30 minutes)

#### 4.1 Unit Tests ‚úÖ

```bash
npm test -- alertManager.test.ts
```

#### 4.2 Web Browser Testing

**Test Setup:**
1. Enable notifications in browser
2. Open draft room
3. Trigger each alert condition

**Test Cases:**
- [ ] Room fills ‚Üí "Room Filled" alert fires
- [ ] Draft countdown starts ‚Üí "Draft Starting" alert fires
- [ ] Two picks away ‚Üí "Two Picks Away" alert fires
- [ ] My turn starts ‚Üí "On The Clock" alert fires
- [ ] Timer hits 10s ‚Üí "10 Seconds Remaining" alert fires
- [ ] Click notification ‚Üí Opens draft room
- [ ] Viewing draft room ‚Üí No notification (sound only)

#### 4.3 iOS Device Testing

**Requirements:**
- iPhone 14 Pro or later
- iOS 16.1+
- App installed via Xcode

**Test Cases:**
- [ ] All 5 alert types appear in Dynamic Island
- [ ] Alerts auto-dismiss after 5 seconds
- [ ] Alerts show correct icons and colors
- [ ] Lock screen shows alert content
- [ ] Tap Dynamic Island ‚Üí Opens app to draft room

#### 4.4 Edge Cases

- [ ] Timer skips 10 (goes 11‚Üí9) ‚Üí Alert still fires
- [ ] Multiple rounds ‚Üí Alerts fire in each round
- [ ] Tab switching ‚Üí Alerts work when tab hidden
- [ ] Permission denied ‚Üí Graceful fallback
- [ ] No Dynamic Island ‚Üí Falls back to web notifications

---

## üîç Troubleshooting

### Service Worker Not Merging

**Problem:** Notification clicks don't open draft room

**Solution:**
1. Check `public/sw.js` contains `notificationclick` handler
2. If missing, run: `node scripts/merge-service-worker.js`
3. Clear browser cache and reload

### iOS Alerts Not Showing

**Problem:** Alerts don't appear in Dynamic Island

**Checklist:**
- [ ] Live Activities capability enabled in Widget Extension
- [ ] `DraftAlertManager.swift` added to main app target
- [ ] `DraftAlertWidget.swift` added to Widget Extension target
- [ ] WebView message handler added and connected
- [ ] Testing on physical device (not simulator)
- [ ] iOS 16.1+ and iPhone 14 Pro+

### Web Notifications Not Working

**Problem:** Browser notifications don't appear

**Checklist:**
- [ ] Notification permission granted
- [ ] Service worker registered
- [ ] Testing in supported browser (Chrome, Safari, Firefox)
- [ ] Not testing in incognito/private mode

### Alerts Firing Too Often

**Problem:** Duplicate alerts in same round

**Solution:**
- Check `currentRound` and `currentPick` are being passed correctly
- Verify deduplication keys include round context
- Clear localStorage: `localStorage.clear()` in console

### Alerts Not Firing

**Problem:** No alerts appear

**Checklist:**
- [ ] User preferences enabled in Profile Settings
- [ ] Alert conditions actually met (check console logs)
- [ ] Tab visibility check not blocking (try switching tabs)
- [ ] Notification permissions granted

---

## üìö File Reference

### Core Files
- `lib/draftAlerts/` - All TypeScript alert system code
- `components/vx2/draft-logic/hooks/useDraftAlerts.ts` - React hook
- `components/vx2/draft-room/hooks/useDraftRoom.ts` - Integration point

### iOS Files
- `ios/DynamicIsland/Managers/DraftAlertManager.swift` - Alert manager
- `ios/DynamicIsland/Widgets/DraftAlertWidget.swift` - Widget views
- `ios/DynamicIsland/README_ALERTS.md` - iOS integration guide

### Configuration
- `public/sw-custom.js` - Service worker handler
- `scripts/merge-service-worker.js` - Post-build merge script
- `package.json` - Build script updated

### Documentation
- `IMPLEMENTATION_SUMMARY_DYNAMIC_ISLAND_ALERTS.md` - Complete summary
- `lib/draftAlerts/README.md` - System documentation
- `INTEGRATION_GUIDE_DYNAMIC_ISLAND_ALERTS.md` - This file

---

## ‚úÖ Success Criteria

- [x] All 5 alert types implemented
- [x] Individual preferences working
- [x] Dynamic Island code complete
- [x] Web notifications code complete
- [x] Service worker handler automated
- [x] Unit tests created
- [ ] Sound files added
- [ ] iOS WebView handler integrated
- [ ] Device testing complete

---

## üöÄ Next Steps After Integration

1. **Monitor Analytics**
   - Track alert delivery rates
   - Monitor notification permission grants
   - Measure user engagement with alerts

2. **User Feedback**
   - Collect feedback on alert timing
   - Adjust alert messages if needed
   - Consider additional alert types

3. **Optimization**
   - Fine-tune alert timing
   - Optimize sound file sizes
   - Reduce battery impact

---

**Questions?** See `IMPLEMENTATION_SUMMARY_DYNAMIC_ISLAND_ALERTS.md` for detailed technical information.
